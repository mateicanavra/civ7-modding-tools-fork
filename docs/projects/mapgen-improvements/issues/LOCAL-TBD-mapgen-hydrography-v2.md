---
id: LOCAL-TBD-mapgen-hydrography-v2
title: "Derive lakes + navigable rivers from physics (Hydrology V2)"
state: planned
priority: 2
estimate: 0
project: mapgen-improvements
milestone: null
assignees: [codex]
labels: [mapgen, hydrology, lakes, rivers, algorithms]
parent: null
children: []
blocked_by: []
blocked: []
related_to: []
---

<!-- SECTION SCOPE [SYNC] -->
## TL;DR
- Replace outcome-driven lake/river projection knobs with a physics-driven Hydrography V2 model:
  - lakes become an emergent result of **(topography + climate + storage/ET physics)**, including seasonal lakes,
  - rivers/navigability become an emergent result of **(discharge + slope + valley confinement)**.

## Deliverables
- A Linear-issue-grade implementation plan for Hydrography V2 (lakes + rivers).
- Inventory of existing pipeline inputs + any new derived inputs/artifacts needed.
- Testing + measurement plan based on invariants + distributional metrics (not quotas).
- A clear “remove legacy knobs” cutover plan.

## Acceptance Criteria
- No authored/outcome-style knobs for hydrography (e.g. no “target lake count”, “tiles per lake”, “min/max river length” as author-facing intent).
- Lakes are fully derivative of topography + climate; seasonal lakes are supported without introducing multiple downstream “map states”.
- Navigable rivers are fully derivative of discharge + slope + confinement and/or channel geometry proxies (not engine-only length knobs).
- “Knobs” remain author-facing presets, but only as bundles over physics params/inputs (no direct outcome targeting).
- Tests assert determinism + monotonic responses to physics param/input changes; measurements exist for “how different/better”.

## Testing / Verification
- Determinism: same seed + same configs ⇒ identical hydrography outputs.
- Monotonicity (distributional, not quota): wetter climate / lower PET ⇒ stochastically more/larger lake extents + stronger river network signal.
- Monotonicity: higher discharge + lower slope + lower confinement ⇒ more navigable channels.
- A/B instrumentation exists to compare “old” vs “v2” on fixtures (see Measurement).

## Dependencies / Notes
- This issue is intentionally algorithm-first; engine adapter limitations must not define the model.
- Existing pipeline surfaces to coordinate with:
  - `artifact:morphology.topography` and `artifact:morphology.routing` (including `routingElevation`) in `mods/mod-swooper-maps/src/recipes/standard/stages/morphology-pre/artifacts.ts`.
  - `artifact:hydrology.hydrography` in `mods/mod-swooper-maps/src/recipes/standard/stages/hydrology-hydrography/artifacts.ts`.
  - Engine-facing lake projection step `mods/mod-swooper-maps/src/recipes/standard/stages/map-hydrology/steps/lakes.ts`.

---

<!-- SECTION IMPLEMENTATION [NOSYNC] -->
## Implementation Details (Local Only)

### Context: what we have today (and what’s wrong with it)

#### Rivers truth vs projection
- Hydrology truth publishes `artifact:hydrology.hydrography` (runoff/discharge/riverClass + sink/outlet masks): `mods/mod-swooper-maps/src/recipes/standard/stages/hydrology-hydrography/steps/rivers.ts`.
- River classes are currently “projection-only” from discharge using percentile thresholds: `mods/mod-swooper-maps/src/domain/hydrology/ops/project-river-network/strategies/default.ts`.
- “Navigable rivers” in gameplay are generated by the engine later (`modelRivers`), while ecology planning currently derives `navigableRiverMask` from `hydrography.riverClass === 2` (truth/projection mismatch risk):
  - `mods/mod-swooper-maps/src/recipes/standard/stages/ecology/steps/features-plan/index.ts`
  - `mods/mod-swooper-maps/src/recipes/standard/stages/map-hydrology/steps/plotRivers.ts`

#### Lakes projection (smells)
- Current gameplay lake projection includes outcome-style controls:
  - `tilesPerLakeMultiplier` config + `targetLakeCount`/random selection derived from `LakeGenerationFrequency` in `mods/mod-swooper-maps/src/recipes/standard/stages/map-hydrology/steps/lakes.ts`.
- This is precisely the wrong direction: lakes must be derivative of basins + climate, not quotas.

### Goals (algorithmic)
- Make lakes and rivers emergent from physical inputs already in the pipeline (topography + climate), while allowing author-facing presets to shift *physics*.
- Preserve the “knobs vs params” boundary:
  - Knobs: gameplay/author intent bundles (wet/dry world, young/old world, etc.).
  - Advanced config: physics params and physics inputs only (no outcome targets).

### Non-goals
- Perfect hydrodynamics / full 2D shallow-water simulation.
- Replacing every engine surface immediately (projection strategy can be phased).

### Decision: seasonal lakes representation (wet/dry without multi-state explosion)
- Canonical output: per-tile **`floodedFraction01`** (0..1, representing fraction of the annual cycle flooded).
- Derived outputs (optional, for tests/debug):
  - `wetSeasonFloodMask` and `drySeasonFloodMask`.
- Engine stamping uses a single view derived from the same model:
  - `permanentMask = floodedFraction01 >= permanenceThreshold` (default threshold is a physics preset; not an outcome knob).

### Inventory: existing inputs we can already leverage

#### Morphology / routing
- `elevation: Int16Array` + `landMask: Uint8Array` + `seaLevel`: `artifact:morphology.topography`.
- `flowDir: Int32Array` + optional `routingElevation: Float32Array` (Priority-Flood surface): `artifact:morphology.routing`.

#### Climate
- Baseline rainfall/humidity fields (already used by Hydrology discharge): `artifact:hydrology.climateField`.
- Seasonality amplitudes already exist as a published artifact (rainfall/humidity amplitude fields): `mods/mod-swooper-maps/src/recipes/standard/stages/hydrology-climate-baseline/artifacts.ts`.

#### Land water budget proxies (already implemented)
- PET + aridity index exist and are reusable “physics-ish” indices:
  - `mods/mod-swooper-maps/src/domain/hydrology/ops/compute-land-water-budget/contract.ts`.

### New derived inputs we should add (Hydrography V2)

#### (1) Local slope proxy on the routing surface
- Compute `slope01[i] = clamp01((routingElevation[i] - routingElevation[receiver]) / maxDropM)`.
- Use `routingElevation` when present; fallback to raw `elevation`.
- This matches the spirit of Morphology’s erosion stream-power proxy (see `mods/mod-swooper-maps/src/domain/morphology/ops/compute-geomorphic-cycle/rules/index.ts`).

#### (2) Valley confinement proxy (0..1; higher = more confined)
Use a deterministic, resolution-appropriate proxy rather than a GIS-grade vector method:
- Compute “cross-valley relief” on a radius-R neighborhood:
  - estimate local valley floor as `routingElevation` along the flowline,
  - estimate valley walls from max elevation in a perpendicular-ish neighborhood ring,
  - `confinement01 = clamp01((wallElev - floorElev) / reliefScaleM)` combined with low-slope gating.
- Goal is not cartographic perfection; it’s a stable proxy that makes:
  - confined canyons: high confinement,
  - broad alluvial valleys/plains: low confinement.

#### (3) Depression / basin hierarchy (for lakes as storage)
From `fillDelta = routingElevation - elevation`:
- Segment contiguous `fillDelta > 0` regions into depression ids.
- For each depression, compute:
  - `spillElevationM` (minimum boundary elevation on routing surface),
  - `hypsometry` (area-vs-level curve, coarse-binned),
  - `maxFillDepthM` and `filledArea` at spill.

### Hydrography V2 Model

#### Runoff model (physics-driven, still cheap)
Replace “rainfall only” runoff with a budget-aware runoff proxy:
- Inputs: rainfall/humidity + PET (+ optional temperature proxy).
- Use a simple annual/seasonal water balance:
  - `runoff = max(0, precipEff - infil - ET)`, where `ET` is bounded by PET and humidity.
  - Keep this deterministic and unit-consistent (in “rainfall units”).
- This turns “river density” into a physics effect (how much water actually becomes runoff), not an output threshold hack.

#### River channel geometry + class
Replace percentile thresholds with physically interpretable thresholds:
- Continuous fields:
  - `channelWidthTiles` proxy derived from discharge and modifiers:
    - base hydraulic geometry: `width ∝ Q^b` (see Leopold & Maddock; typical b ~ 0.3–0.6).
    - apply slope and confinement postures as modifiers (high slope and high confinement suppress width / navigability).
  - optional `streamPower01 ∝ Q^m * S^n` (normalize for debug and gating).
- Classification:
  - `riverClass` can remain 0/1/2, but thresholds should be expressed in physical proxy terms:
    - minor: `channelWidthTiles >= wMinor`,
    - major: `channelWidthTiles >= wMajor`,
    - navigable: `channelWidthTiles >= wNav && slope01 <= sNavMax && confinement01 <= cNavMax`.

#### Lakes as storage + water balance (no quotas)
For each depression basin:
- Compute annual inflow proxy from contributing runoff/discharge upstream.
- Compute evaporation loss using PET and seasonal modulation (see Seasonality).
- Solve for equilibrium water level:
  - if equilibrium level reaches spill elevation ⇒ exorheic lake with outflow,
  - if equilibrium remains below spill ⇒ endorheic lake (closed basin) if wet enough to persist; else a dry basin (no lake tiles).
- Output per tile:
  - `floodedFraction01` (canonical),
  - optional lake id + lake type classification (exorheic/endorheic/seasonal).

### Author-facing knobs vs advanced config

#### Knobs (presets; gameplay/author intent)
- `dryness` and `temperature` remain climate-shaping knobs (already exist).
- Add/replace hydrography-facing knobs with bundles over physics params:
  - `inlandWater`: `"low"|"normal"|"high"` → changes infiltration/seepage + PET scaling + depression storage efficiency.
  - `riverCharacter`: `"braided"|"meandering"|"mixed"` (optional) → changes width/slope response and confinement sensitivity.
  - `worldAge`: `"young"|"normal"|"old"` (optional) → affects confinement proxy scale / valley widening preference (physics preset), not counts.

#### Advanced config (physics params/inputs only)
Examples (names TBD; values must be unit-consistent):
- Runoff: infiltration fraction, PET scaling, humidity dampening, minimum runoff floor.
- Lakes: seepage rate, lake evaporation scaling, permanence threshold (as a physics preset), hypsometry bin count.
- Rivers: width coefficient, discharge exponent `b`, slope exponent(s), confinement influence coefficient, navigability width threshold(s).

### Measurement: “how much better”
Add fixture-based A/B metrics (deterministic, no quotas):
- River continuity:
  - distribution of `channelWidthTiles`,
  - connected length distribution of major/navigable masks.
- Lake realism proxies:
  - % of lake tiles overlapping depressions (`fillDelta > 0`),
  - lake permanence distribution vs aridity index (wet worlds should not create many dry basins; dry worlds should concentrate endorheic/seasonal).
- Truth vs projection mismatch score (while engine projection exists):
  - Jaccard overlap between `hydrographyNavigableMask` and `engineNavigableRiverTerrainMask` after `plotRivers`.

### Cutover plan (remove legacy/outcome knobs)
Phased cutover to keep the repo working at each step:
1) Add Hydrography V2 derived fields behind a feature flag / strategy, keeping current `riverClass` available.
2) Replace percentile-based `project-river-network` in the default strategy with a width-based classifier (deprecate percentiles).
3) Replace lake projection:
   - delete `tilesPerLakeMultiplier` and any `targetLakeCount`-style fields,
   - stamp lakes from `artifact:hydrology.lakes` (or `artifact:hydrology.hydrography` extension) using `floodedFraction01` derived permanence mask.
4) Reconcile navigable river semantics:
   - either defer ecology “navigable” constraints until after engine rivers exist, or stamp owned navigable river terrain when we have sufficient adapter/engine clarity.

### Open questions (decisions to make before coding)
1) Seasonality mapping: how to map `rainfallAmplitude` / `humidityAmplitude` into wet/dry multipliers in a way that is stable and intuitive.
2) Basin hierarchy scope: do we only model lakes in “filled” depressions (`fillDelta>0`), or also allow “flat lowlands reservoirs” (probably not initially).
3) Projection posture: when do we stop depending on engine `generateLakes` / `modelRivers` for gameplay-facing results?
4) Performance: hypsometry/volume solve must be O(n) or O(n log n) with tight constants; choose binning strategy carefully.

### References (for algorithm grounding; not implementation binding)
- Priority-Flood depression handling (Barnes et al. 2014): https://doi.org/10.1016/j.cageo.2013.04.024
- Hydraulic geometry (width vs discharge) foundational reference: Leopold & Maddock (USGS Prof. Paper 252): https://pubs.er.usgs.gov/publication/pp252
- Valley confinement algorithm (GIS-grade reference; we will adapt to grid proxies): https://doi.org/10.1016/j.geomorph.2014.03.032
- Stream power incision model overview (grounding for `Q` + slope relationships): https://doi.org/10.1002/esp.3841
