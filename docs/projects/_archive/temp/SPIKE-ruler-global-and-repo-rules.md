# SPIKE: Ruler (global + repo) with canonical `AGENTS.md`, plus global prompts

## Objective

Evaluate adopting `intellectronica/ruler` to:

- apply consistent “rules” globally and per-repo
- keep this repo’s `AGENTS.md` routers as the canonical source of truth
- understand how this relates to (or replaces) global “slash commands/prompts” like:
  - `/Users/mateicanavra/.claude/commands/dev.md`
  - `/Users/mateicanavra/.codex/prompts/dev.md`

## What Ruler is (in practice)

Ruler is a CLI that reads Markdown “rules” and then **writes agent-specific config files** for supported tools (e.g. `CLAUDE.md`, `.mcp.json`, `.codex/config.toml`, etc.).

It has two key concepts:

- a **rules directory** (local `.ruler/` if present, otherwise global `~/.config/ruler/` via XDG)
- a **TOML config** (`ruler.toml`) controlling which “agents” get outputs and where

## Key findings (how it resolves local vs global)

- Ruler searches upward from the project root for a local `.ruler/` directory; the nearest one wins.
- If no local `.ruler/` exists, it falls back to the global config dir: `$XDG_CONFIG_HOME/ruler` (usually `~/.config/ruler`).
- `ruler.toml` resolution mirrors that: local `.ruler/ruler.toml` first, else global `~/.config/ruler/ruler.toml`.

Implication: **once you add a repo-local `.ruler/`, global Ruler rules no longer apply to that repo** (except anything already in the repo itself).

## Critical caveat for this repo: don’t let Ruler overwrite `AGENTS.md`

This repo already uses `AGENTS.md` as a durable “domain router” system (root + nested routers).

Ruler includes an `agentsmd` pseudo-agent that writes a **generated** root `AGENTS.md` (it prepends `<!-- Generated by Ruler -->`).

Additionally, multiple agent adapters (including OpenAI Codex CLI and Cursor) write to `AGENTS.md` by default as part of their integration strategy.

Implication: if Ruler is run with default settings, it can **clobber the canonical `AGENTS.md`** and replace it with a generated concatenation.

Guardrail: always constrain agent selection and/or output paths so root `AGENTS.md` stays human-owned.

## Agent selection hazard: default is “all agents”

Agent selection precedence is:

1) CLI `--agents`
2) `default_agents` in `ruler.toml`
3) per-agent `enabled` flags
4) otherwise: **all agents**

Implication: to avoid unexpected writes, we should always set `default_agents` explicitly (global and repo).

## Recommendation

### 1) Global Ruler (developer machine baseline)

Use global Ruler to provide a baseline for repos that *don’t* have a local `.ruler/`.

Recommended shape:

- Put personal, cross-repo rules in `~/.config/ruler/AGENTS.md` (or `$XDG_CONFIG_HOME/ruler/AGENTS.md`).
- Set `~/.config/ruler/ruler.toml` with an explicit, conservative `default_agents` (start with `claude` only).

Avoid including agents that write `AGENTS.md` unless you also configure their output paths to non-canonical destinations.

### 2) Repo-local Ruler (team-consistent behavior for this repo)

If we want team-consistent propagation (especially MCP + agent configs), add a repo-local `.ruler/ruler.toml`.

Recommended “safe default” for this repo:

- `default_agents` should **not** include anything that writes `AGENTS.md` by default (notably `agentsmd`, `codex`, `cursor`) unless those agents are configured to write elsewhere.
- Use `claude` to generate `CLAUDE.md` from canonical repo `AGENTS.md` + any additional `.ruler/*.md` (if we choose to add them).

Important: introducing `.ruler/` in the repo means global `~/.config/ruler` rules will stop applying here; that’s usually fine if the repo’s own routers already capture what we want.

### 3) Global “slash commands/prompts” are a different system (Ruler doesn’t replace them)

Your global prompt trees:

- `~/.claude/commands/*.md`
- `~/.codex/prompts/*.md`

are **not** something Ruler manages. Ruler’s closest adjacent feature is “skills”, which propagates a project’s `.ruler/skills/` to `.claude/skills/` (and optionally to a `.skillz/` MCP-based skills runtime), but that’s not the same as global `/dev` style commands.

Recommendation:

- keep managing global commands/prompts using your existing parity workflow
- optionally consolidate them into a single canonical directory and sync/symlink into both trees (separate effort from Ruler adoption)

## Suggested rollout (thin-slice)

1) Start with global Ruler only:
   - install + init global config
   - set conservative `default_agents` so it cannot touch repo `AGENTS.md` unexpectedly
2) Add repo-local `.ruler/ruler.toml` only after:
   - deciding which agent outputs we want committed vs ignored
   - confirming we can avoid modifying canonical routers
3) (Optional) Add a “ruler check” CI job only if we decide generated artifacts should be committed and enforced.

## Open decisions / questions

1) Which agents do we want Ruler to support in this repo (Claude only, or also Codex/Cursor for MCP)?
2) Do we want generated outputs (e.g. `CLAUDE.md`, `.mcp.json`, `.codex/config.toml`) committed, or treated as local-only?
3) Do we want global prompts consolidated (symlink/sync) or keep the current duplicated-but-parity-managed approach?

