# Agent scratch — Cohesion/Integrity/Completeness

## Scope
- Audit canonical Phase 2 model for contradictions, missing details, drift risks, underspec.
- Own “overall health” going into Phase 3.

## 1) Contradictions / inconsistencies
- Freeze point set is inconsistent across Phase 2 canon: `docs/projects/engine-refactor-v1/resources/workflow/domain-refactor/plans/morphology/spec/PHASE-2-CORE-MODEL-AND-PIPELINE.md` “3.2 Canonical freeze points (Phase 2 named)” defines F1–F5, but `docs/projects/engine-refactor-v1/resources/workflow/domain-refactor/plans/morphology/spec/PHASE-2-CONTRACTS.md` “Lifecycle / freeze semantics” only enumerates F1–F2; meanwhile `docs/projects/engine-refactor-v1/resources/workflow/domain-refactor/plans/morphology/spike-morphology-modeling-gpt.md` “Canonical pipeline topology (stages, freeze points, rules)” also uses F1–F5.
- “Gameplay projection vs stamping stage boundary” is modeled two ways: `docs/projects/engine-refactor-v1/resources/workflow/domain-refactor/plans/morphology/spike-morphology-modeling-gpt.md` “Canonical pipeline topology (stages, freeze points, rules)” presents `Gameplay (projection) → Gameplay (materialization/stamping)` as distinct stages, but `docs/projects/engine-refactor-v1/resources/workflow/domain-refactor/plans/morphology/spec/PHASE-2-CORE-MODEL-AND-PIPELINE.md` “4.1 Conceptual phase order (canonical)” collapses to `Gameplay (projection + stamping)` (still requiring “Projection intent freeze” in “3.3”); this ambiguity will cause Phase 3 wiring disagreements unless we lock whether projection is a distinct stage/freeze boundary vs an intra-stage freeze contract.
- Routing artifact language conflicts with “no routing contract” posture: `docs/projects/engine-refactor-v1/resources/workflow/domain-refactor/plans/morphology/spike-morphology-modeling-gpt.md` “Conceptual model stages and their corresponding ops and outputs” includes “compute-flow-routing … internal, then part of routing artifact”, but `docs/projects/engine-refactor-v1/resources/workflow/domain-refactor/plans/morphology/spec/PHASE-2-CONTRACTS.md` “Disallowed / non-contract surfaces” explicitly bans `artifact:morphology.routing` as cross-domain, and the spike elsewhere states Morphology does not publish routing as a contract.
- CoastlineMetrics scope language drifts against the locked schema posture: `docs/projects/engine-refactor-v1/resources/workflow/domain-refactor/plans/morphology/spike-morphology-modeling-gpt.md` “Morphology outputs” describes coastline metrics as “any other coastline-derived metrics…”, while `docs/projects/engine-refactor-v1/resources/workflow/domain-refactor/plans/morphology/spec/PHASE-2-CONTRACTS.md` “artifact:morphology.coastlineMetrics” locks a specific field list; the spike’s language reads like permission to extend the schema without updating the contract.

## 2) Missing or underspecified items
- No explicit seed/RNG contract exists in Phase 2 canon: `docs/projects/engine-refactor-v1/resources/workflow/domain-refactor/plans/morphology/spec/PHASE-2-CONTRACTS.md` “Determinism requirements” references “deterministic seed inputs (when the contract includes an explicit seed input)”, but none of the Phase 2 `spec/PHASE-2-*` docs define what the seed surface is (`env` input vs Morphology config vs per-op seed). This is a determinism hole (Phase 3 will otherwise invent inconsistent seed threading).
- Morphology config contract is not locked in `spec/`: Phase 2 canon repeatedly depends on “normalized config” (e.g., `docs/projects/engine-refactor-v1/resources/workflow/domain-refactor/plans/morphology/spec/PHASE-2-CORE-MODEL-AND-PIPELINE.md` “5) Morphology causality spine” (steps 3 and 5) and “bounded iteration count is fixed by normalized config”), but there is no canonical `MorphologyConfig` schema/normalize contract in `spec/PHASE-2-CONTRACTS.md` (or anywhere under `spec/`). This is not “micro numeric method”; it’s a public contract input.
- “Publish-once handle” semantics are used but not defined canonically: multiple artifacts in `docs/projects/engine-refactor-v1/resources/workflow/domain-refactor/plans/morphology/spec/PHASE-2-CONTRACTS.md` specify “publish-once handle; frozen as truth at F2”, but `docs/projects/engine-refactor-v1/resources/workflow/domain-refactor/plans/morphology/spec/PHASE-2-CORE-MODEL-AND-PIPELINE.md` “1) Glossary” does not define what a “publish-once handle” guarantees in the artifact store (aliasing, in-place mutation during Build, snapshot semantics at Freeze).
- Canonical tile neighbor graph is referenced but not locked: `docs/projects/engine-refactor-v1/resources/workflow/domain-refactor/plans/morphology/spec/PHASE-2-CONTRACTS.md` relies on “canonical hex tile neighbor graph” for boundary distance fields, coastline adjacency, connected components, etc., but does not pin (a) neighbor ordering, (b) coordinate system (odd-q vs axial), or (c) exact wrap behavior at seam/poles. Without this, determinism tie-breakers can silently diverge across implementations.
- Landmass determinism has two high-impact ambiguities:
  - `docs/projects/engine-refactor-v1/resources/workflow/domain-refactor/plans/morphology/spec/PHASE-2-CONTRACTS.md` “artifact:morphology.landmasses” uses `coastlineLength` as a tie-breaker but does not define exactly how coastline edges are counted (e.g., count each land↔water adjacency once vs from both sides; include polar edge as coastline or not).
  - The wrapped bbox encoding is specified, but the canonical computation rule is not (when a landmass crosses the seam there are multiple equivalent encodings; Phase 3 needs a deterministic “choose interval” algorithm and tie-breakers or IDs will drift).
- Foundation mesh→tile projection rule is contract-critical but missing some definitional anchors: `docs/projects/engine-refactor-v1/resources/workflow/domain-refactor/plans/morphology/spec/PHASE-2-CONTRACTS.md` “Canonical mesh → tile projection (deterministic)” uses `projectOddqToHexSpace` and `mesh.wrapWidth` but does not define their units/relationship to tile `width` and `artifact:foundation.mesh.siteX/siteY` units. This is a drift risk for `artifact:foundation.plates` correctness (and downstream Morphology truth).
- Map projection surfaces are incomplete relative to the stamping/effects posture:
  - `docs/projects/engine-refactor-v1/resources/workflow/domain-refactor/plans/morphology/spec/PHASE-2-MAP-PROJECTIONS-AND-STAMPING.md` “3) Required artifact:map.* surfaces” only defines `artifact:map.projectionMeta` and the LandmassRegion projection, but `docs/projects/engine-refactor-v1/resources/workflow/domain-refactor/plans/morphology/spec/PHASE-2-MAP-PROJECTIONS-AND-STAMPING.md` “4.1 Canonical effect taxonomy” canonizes `effect:map.mountainsPlotted`, `effect:map.volcanoesPlotted`, etc.
  - `docs/projects/engine-refactor-v1/resources/workflow/domain-refactor/plans/morphology/spec/PHASE-2-CORE-MODEL-AND-PIPELINE.md` “3.3 Projection intent freeze” requires intent artifacts to be frozen before stamping begins; with no intent artifacts defined for mountains/terrain/features/volcanoes, Phase 3 may stamp directly from physics without a stable `artifact:map.*` boundary, which undermines the “effect honesty via intent freeze” claim.
- Intra-step intent vs freeze boundary is ambiguous: `docs/projects/engine-refactor-v1/resources/workflow/domain-refactor/plans/morphology/spec/PHASE-2-MAP-PROJECTIONS-AND-STAMPING.md` “2.2 effect:map.*Plotted is execution” allows a `plot-*` step to “optionally compute/publish artifact:map.* intent” and then stamp in the same step; `docs/projects/engine-refactor-v1/resources/workflow/domain-refactor/plans/morphology/spec/PHASE-2-CORE-MODEL-AND-PIPELINE.md` “3.3 Projection intent freeze” reads like intent must be frozen *before* stamping begins as a distinct boundary. Clarify whether “publish then stamp in same step” satisfies the freeze invariant (and if so, what “frozen” means operationally).
- Engine postprocess calls appear to be able to mutate land/water classification, which is incompatible with “physics truth is canonical” unless we explicitly constrain/ban them:
  - `expandCoasts` is followed by syncing `heightfield.landMask[i] = adapter.isWater(x,y) ? 0 : 1` in `mods/mod-swooper-maps/src/recipes/standard/stages/morphology-pre/steps/coastlines.ts` (so the adapter can change “isWater”).
  - `validateAndFixTerrain()` is invoked in `mods/mod-swooper-maps/src/recipes/standard/stages/morphology-pre/steps/landmassPlates.ts` before publishing `heightfield` buffers as `topography` (legacy). Phase 2 must answer: are such engine calls allowed only if they are proven not to change `isWater` vs the physics `landMask` truth? If they can change it, then either (a) the call is disallowed in the canonical Phase 2 pipeline, or (b) “truth vs engine” precedence rules are missing.

## 3) Drift risks / duplicated truth
- Entrypoint plan points at non-existent/renamed artifacts, creating “edit the wrong doc” drift: `docs/projects/engine-refactor-v1/resources/workflow/domain-refactor/plans/morphology/MORPHOLOGY.md` “Phase artifacts (authoritative links)” references `.../spike-morphology-modeling.md` and similar, but the actual canonical files are `.../spike-morphology-modeling-gpt.md` and peers. This is likely for Agent (Structure), but it is a real canon drift vector.
- Freeze points and lifecycle semantics are duplicated across `docs/projects/engine-refactor-v1/resources/workflow/domain-refactor/plans/morphology/spike-morphology-modeling-gpt.md` and `docs/projects/engine-refactor-v1/resources/workflow/domain-refactor/plans/morphology/spec/PHASE-2-CORE-MODEL-AND-PIPELINE.md`. The spike states “spec wins” but still restates the same invariants; this invites silent divergence over time.
- Effect taxonomy is canonized in `docs/projects/engine-refactor-v1/resources/workflow/domain-refactor/plans/morphology/spec/PHASE-2-MAP-PROJECTIONS-AND-STAMPING.md`, while `docs/projects/engine-refactor-v1/resources/workflow/domain-refactor/plans/morphology/spike-morphology-modeling-gpt.md` also discusses effect tags; ensure there is exactly one canonical list (and that it is linked to the tag registry doc) or recipes will mint new effects ad-hoc.

## 4) Concrete patch suggestions (smallest set of edits to reach closure)
- Lock freeze point enumeration in one place:
  - Patch `docs/projects/engine-refactor-v1/resources/workflow/domain-refactor/plans/morphology/spec/PHASE-2-CONTRACTS.md` “Lifecycle / freeze semantics” to reference the full F1–F5 set defined in `docs/projects/engine-refactor-v1/resources/workflow/domain-refactor/plans/morphology/spec/PHASE-2-CORE-MODEL-AND-PIPELINE.md` “3.2 Canonical freeze points (Phase 2 named)”, even if only F1/F2 are used by Morphology contracts.
  - Patch `docs/projects/engine-refactor-v1/resources/workflow/domain-refactor/plans/morphology/spec/PHASE-2-CORE-MODEL-AND-PIPELINE.md` “3.3 Projection intent freeze” to explicitly state whether Gameplay projection is a distinct stage (with its own freeze point) vs an intra-stage freeze boundary inside Gameplay.
- Remove routing artifact ambiguity:
  - Patch `docs/projects/engine-refactor-v1/resources/workflow/domain-refactor/plans/morphology/spike-morphology-modeling-gpt.md` “Conceptual model stages and their corresponding ops and outputs” to replace “part of routing artifact” with “internal buffers only (not published as an artifact)”, and link to `docs/projects/engine-refactor-v1/resources/workflow/domain-refactor/plans/morphology/spec/PHASE-2-CONTRACTS.md` “Disallowed / non-contract surfaces”.
- Define missing contract anchors required for determinism:
  - Add a short “Seed inputs” subsection to `docs/projects/engine-refactor-v1/resources/workflow/domain-refactor/plans/morphology/spec/PHASE-2-CONTRACTS.md` “Global invariants” that defines the canonical seed surface(s) and scoping rules (pipeline seed vs domain seed vs op seed).
  - Add a short “Tile neighbor graph” subsection to `docs/projects/engine-refactor-v1/resources/workflow/domain-refactor/plans/morphology/spec/PHASE-2-CONTRACTS.md` “Global invariants” (or to `docs/projects/engine-refactor-v1/resources/workflow/domain-refactor/plans/morphology/spec/PHASE-2-CORE-MODEL-AND-PIPELINE.md` “1) Glossary”) that pins odd-q/neighbor ordering and references `packages/mapgen-core/src/lib/grid/neighborhood/hex-oddq.ts`.
  - Extend `docs/projects/engine-refactor-v1/resources/workflow/domain-refactor/plans/morphology/spec/PHASE-2-CONTRACTS.md` “artifact:morphology.landmasses” with explicit coastlineLength counting rule and canonical wrapped bbox computation rule (minimal-width interval selection + tie-breakers).
  - Add “publish-once handle” definition to `docs/projects/engine-refactor-v1/resources/workflow/domain-refactor/plans/morphology/spec/PHASE-2-CORE-MODEL-AND-PIPELINE.md` “1.1 Data surfaces”.
- Close the `artifact:map.*` completeness gap (may require coordination with Agent (Phase 3 seeds) because it impacts Phase 3 wiring):
  - Patch `docs/projects/engine-refactor-v1/resources/workflow/domain-refactor/plans/morphology/spec/PHASE-2-MAP-PROJECTIONS-AND-STAMPING.md` “3) Required artifact:map.* surfaces (Phase 2)” to either:
    1) define minimal required intent artifacts for each canonized `effect:map.*Plotted` (at least terrain/mountains/volcano features), or
    2) explicitly state which effects are allowed to stamp directly from physics truth without publishing any `artifact:map.*` intent (and then reconcile with `docs/projects/engine-refactor-v1/resources/workflow/domain-refactor/plans/morphology/spec/PHASE-2-CORE-MODEL-AND-PIPELINE.md` “3.3 Projection intent freeze”).
- Constrain (or remove) engine geometry-mutating postprocesses:
  - Patch `docs/projects/engine-refactor-v1/resources/workflow/domain-refactor/plans/morphology/spec/PHASE-2-MAP-PROJECTIONS-AND-STAMPING.md` “7.2 plot-coasts” and “6) Civ7 stamping/materialization: required engine calls and ordering constraints” to explicitly state whether `expandCoasts` / `validateAndFixTerrain` are permitted to change `isWater` (land/water truth). If not permitted, require a Phase 3 guardrail test/assertion and treat any change as an integration failure; if permitted, we need an explicit “truth vs engine” precedence rule and must reconcile downstream physics correctness.
- Fix the entrypoint drift (likely for Agent (Structure)):
  - Patch `docs/projects/engine-refactor-v1/resources/workflow/domain-refactor/plans/morphology/MORPHOLOGY.md` “Phase artifacts (authoritative links)” to point at the actual `*-gpt.md` filenames.

## 5) Must-ask orchestrator questions
- Do we want Gameplay projection to be a distinct stage with its own named freeze point (e.g., between F4 and F5), or is “projection intent freeze” an intra-stage contract within Gameplay? (This decides whether the spike’s two-Gameplay-stage model is aligned or needs collapsing.)
- Where should the canonical RNG seed surface live: Environment contract (global pipeline seed), domain config (`MorphologyConfig.seed`), or per-op seeds derived from a root seed? (Need one canonical answer to avoid Phase 3 determinism drift.)
- For `effect:map.mountainsPlotted` / `effect:map.volcanoesPlotted` / `effect:map.featuresPlotted` etc, do we require corresponding `artifact:map.*` intent surfaces (preferred for “intent freeze” honesty), or is “stamp directly from physics truth” acceptable for some effects? If acceptable, how do we keep effects honest without intent artifacts?
- Are engine “fixup” calls (`validateAndFixTerrain`, `expandCoasts`) required in the target pipeline? If yes, we need a Phase 2 canonical rule about whether they are allowed to change water/land classification; otherwise they create de-facto engine backfeeding that breaks purity and invalidates earlier physics-derived projections.
- Are we comfortable with `artifact:foundation.plates` being defined via a nearest-site projection requiring `projectOddqToHexSpace` semantics (potentially brittle), or should the contract be reframed to pin to an already-existing `tileToCellIndex` artifact/value so consumers don’t need to replicate geometry?
