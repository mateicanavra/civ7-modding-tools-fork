---
title: "LOCAL TBD — Swooper Maps mod build/dist"
status: "TBD"
blocked_by: []
blocks: []
---

# Summary

We want to fix the build process for the Swooper Maps mod so that `mods/mod-swooper-maps/mod/` can be treated as a clean, regenerable "dist" directory:

- Non-JS files under `mod/` (`swooper-maps.modinfo`, `config/config.xml`, `text/en_us/ModuleText.xml`, `text/en_us/MapText.xml`) should be generated from a small, typed config definition rather than hand-authored.
- JS entry + chunk files under `mod/maps/*.js` remain generated by `tsup` and can be safely cleaned between builds.
- After this change, we should be able to `rimraf` / `turbo clean` the `mod/` directory and fully regenerate it via the build pipeline.

We intentionally stay out of the external Civ7 SDK for this task and keep configuration local to the repo.

# Scope / Acceptance Criteria

- `mods/mod-swooper-maps/mod/` is safe to delete before builds; running the mod package build fully recreates:
  - `mod/swooper-maps.modinfo`
  - `mod/config/config.xml`
  - `mod/text/en_us/ModuleText.xml`
  - `mod/text/en_us/MapText.xml`
  - `mod/maps/*.js` via `tsup` (unchanged responsibility)
- All generated files are derived from a single typed config definition checked into source control.
- Existing mod behavior is preserved:
  - Maps still appear in-game with the same names, descriptions, and sort order.
  - Module-level name/description text is unchanged.
  - `.modinfo` still references the correct XML and map script paths.

# Implementation Plan (high level)

1. **Confirm inputs & outputs**
   - Treat `mods/mod-swooper-maps/mod/` as the “dist” for this package.
   - Generated files:
     - `mod/swooper-maps.modinfo`
     - `mod/config/config.xml`
     - `mod/text/en_us/ModuleText.xml`
     - `mod/text/en_us/MapText.xml`
   - Leave `mod/maps/*.js` entirely to `tsup` (stays as-is, just make it safe to clean).

2. **Introduce a typed config model**
   - Add `mods/mod-swooper-maps/mod.config.ts` (or `mods/mod-swooper-maps/build/mod.config.ts` if we prefer a subfolder) exporting a single configuration object.
   - Types:
     - `ModMeta`: `id`, `authors`, `dependencyModId`, `packageName` (e.g. `"Mod"`), module-level loc tags/text.
     - `MapDefinition`: `slug`, `file`, `sortIndex`, `nameTag`, `descriptionTag`, `nameText`, `descriptionText`.
     - `ModDefinition`: `{ meta: ModMeta; maps: MapDefinition[] }`.
   - Helper:
     - `defineMap({ slug, file, sortIndex, uiName, uiDescription }): MapDefinition`, which:
       - Derives `nameTag` / `descriptionTag` from `slug` (`LOC_MAP_<SLUG>_NAME` / `LOC_MAP_<SLUG>_DESCRIPTION`, uppercased snake).
       - Sets `nameText` / `descriptionText` from `uiName` / `uiDescription`.
   - Populate `meta` and `maps` using the current XML and `.modinfo` as the source of truth.

3. **Implement pure XML renderers (Builder-style functions)**
   - In `mods/mod-swooper-maps/build-mod.ts` (or `mods/mod-swooper-maps/build/xml.ts`), implement:
     - `renderConfigXml(def: ModDefinition): string`
       - Static header (`<?xml ...?><Database><Maps>...</Maps></Database>`).
       - For each map, emit:
         - `<Row File="{swooper-maps}/maps/<file>" Name="<nameTag>" Description="<descriptionTag>" SortIndex="<sortIndex>" />`.
     - `renderMapTextXml(def: ModDefinition): string`
       - `<Database><EnglishText>` with:
         - `<Row Tag="<nameTag>"><Text>...</Text></Row>` and `<Row Tag="<descriptionTag>">...</Row>` per map.
     - `renderModuleTextXml(def: ModDefinition): string`
       - Two `<Row>` entries for module name/description tags.
     - `renderModinfoXml(def: ModDefinition): string`
       - Encode the current `.modinfo` structure:
         - `<Mod id="<meta.id>" version="1" xmlns="ModInfo">`
         - `<Properties>` from `meta` (name/description tags, `Authors`, `Package`).
         - Static `<Dependencies>` block (just mod id string from `meta.dependencyModId`).
         - Static `<ActionCriteria>` and `<ActionGroups>` structure, with `<Item>` paths referencing the generated XML files.
         - `<LocalizedText>` referencing `text/en_us/ModuleText.xml`.
       - Keep formatting close to existing files (2-space indent, double quotes), but correctness over whitespace.

4. **Implement the build script (Facade)**
   - In `mods/mod-swooper-maps/build-mod.ts`:
     - Import `fs` / `path` and `modDefinition` from `mod.config.ts`.
     - Compute `MOD_ROOT = path.resolve(__dirname, "mod")` (or ESM-safe equivalent).
     - `cleanModRoot()`:
       - `fs.rmSync(MOD_ROOT, { recursive: true, force: true })`.
       - `fs.mkdirSync(MOD_ROOT, { recursive: true })`.
     - `ensureSubdirs()`:
       - `configDir = path.join(MOD_ROOT, "config")`
       - `textDir = path.join(MOD_ROOT, "text", "en_us")`
       - `mapsDir = path.join(MOD_ROOT, "maps")` (optional: created so deploy doesn’t break before `tsup` runs).
       - `fs.mkdirSync(..., { recursive: true })` for each.
     - `writeFile(relativePath, contents)` helper that joins with `MOD_ROOT` and writes with UTF‑8 and a trailing newline.
     - `buildMod()`:
       - `cleanModRoot()`
       - `ensureSubdirs()`
       - `writeFile("swooper-maps.modinfo", renderModinfoXml(def))`
       - `writeFile("config/config.xml", renderConfigXml(def))`
       - `writeFile("text/en_us/MapText.xml", renderMapTextXml(def))`
       - `writeFile("text/en_us/ModuleText.xml", renderModuleTextXml(def))`
     - Add CLI entry:
       - If CJS: `if (require.main === module) buildMod();`
       - If ESM: small `isMain` helper using `import.meta.url`.
   - This is the only imperative piece; everything else stays pure and testable.

5. **Wire into the build pipeline**
   - In `mods/mod-swooper-maps/package.json`:
     - Add: `"build:config": "bunx tsx build-mod.ts"` (or similar) to leverage Bun where appropriate.
     - Change `build` from plain `tsup` to `bunx tsx build-mod.ts && tsup` (or `pnpm run build:config && tsup`, depending on repo conventions).
     - Add `clean`: `rimraf mod` to integrate with Turbo/monorepo clean, if not already covered elsewhere.
   - In `mods/mod-swooper-maps/tsup.config.ts`:
     - Keep `outDir: "mod/maps"`.
     - Set `clean: true` (safe now; it only wipes `mod/maps`, and our script recreates `mod/` anyway).
   - Net result:
     - `pnpm -C mods/mod-swooper-maps build`:
       - Regenerates all non-JS mod files.
       - Then regenerates JS entries/chunks under `mod/maps`.

6. **Migration & validation**
   - One-time steps:
     - Run the new `build-mod` once and diff generated XML + `.modinfo` against the current hand-authored versions.
     - Fix any mismatches (sorting of `<Row>`s, minor text differences, missed fields).
   - Decide git policy:
     - Easiest initial move: keep `mod/` tracked in git, but treat it as generated; any change comes from editing `mod.config.ts` and rerunning build.
     - Optionally later: add `mod/` to `.gitignore` and ensure CI/build always runs `pnpm run build` before packaging/deploying.
   - Sanity check:
     - Run `pnpm -C mods/mod-swooper-maps build`.
     - Run the existing deploy script to confirm the mod still loads and maps appear correctly.

7. **Future extension hooks (kept minimal)**
   - Add new maps by:
     - Adding a new `defineMap({ ... })` call to `mod.config.ts`.
     - Implementing the corresponding TS entry in `src/` and wiring it into `tsup.config.ts` `entry`.
   - If/when we want JSON configs:
     - Directly mirror `ModDefinition` in JSON and change `mod.config.ts` to import and validate that JSON.

# Complexity / Effort (for future reference)

- Scope is tight, inputs/outputs are explicit, and design choices are mostly local to `mods/mod-swooper-maps`.
- The main recalibration risk is the exact shape of `mod.config.ts` (how much derives from `slug` vs. stored explicitly), which is easy to tweak after a first pass.
- Estimated complexity × effort (1–16, exponential): **4/16** — clearly non-trivial but well-bounded; likely to need at most one small round of feedback rather than multiple direction changes.

