name: Publish Packages

on:
  push:
    tags:
      - "v*.*.*"      # publish both packages
      - "sdk-v*.*.*"  # publish SDK only
      - "cli-v*.*.*"  # publish CLI only
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    env:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: "https://registry.npmjs.org"
          scope: "@civ7"

      - name: Enable Corepack and pin pnpm
        run: |
          corepack enable
          corepack prepare pnpm@10.10.0 --activate

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.local/share/pnpm/store
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Setup Bun (for any Bun-based scripts)
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: ".bun-version"

      - name: Build
        run: pnpm build

      - name: Lint
        run: pnpm lint

      - name: Test
        run: pnpm test

      - name: Typecheck (workspace)
        run: pnpm check

      - name: Validate package versions match tag
        shell: bash
        run: |
          TAG=${GITHUB_REF_NAME#v}
          if [[ $GITHUB_REF_NAME == sdk-v* ]]; then
            TAG=${GITHUB_REF_NAME#sdk-v}
            PKG=$(node -p "require('./packages/sdk/package.json').version")
            if [[ "$PKG" != "$TAG" ]]; then echo "SDK version mismatch: tag=$TAG package.json=$PKG"; exit 1; fi
          elif [[ $GITHUB_REF_NAME == cli-v* ]]; then
            TAG=${GITHUB_REF_NAME#cli-v}
            PKG=$(node -p "require('./packages/cli/package.json').version")
            if [[ "$PKG" != "$TAG" ]]; then echo "CLI version mismatch: tag=$TAG package.json=$PKG"; exit 1; fi
          elif [[ $GITHUB_REF_NAME == v* ]]; then
            SDK=$(node -p "require('./packages/sdk/package.json').version")
            CLI=$(node -p "require('./packages/cli/package.json').version")
            if [[ "$SDK" != "$TAG" ]]; then echo "SDK version mismatch: tag=$TAG package.json=$SDK"; exit 1; fi
            if [[ "$CLI" != "$TAG" ]]; then echo "CLI version mismatch: tag=$TAG package.json=$CLI"; exit 1; fi
          fi

      - name: Determine publish target
        id: target
        run: |
          TAG=${GITHUB_REF_NAME}
          if [[ $TAG == sdk-v* ]]; then echo "target=sdk" >> $GITHUB_OUTPUT; exit 0; fi
          if [[ $TAG == cli-v* ]]; then echo "target=cli" >> $GITHUB_OUTPUT; exit 0; fi
          echo "target=all" >> $GITHUB_OUTPUT

      - name: Publish SDK
        if: env.NPM_TOKEN != '' && (steps.target.outputs.target == 'sdk' || steps.target.outputs.target == 'all')
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: pnpm -F @civ7/sdk publish --access public

      - name: Publish CLI
        if: env.NPM_TOKEN != '' && (steps.target.outputs.target == 'cli' || steps.target.outputs.target == 'all')
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: pnpm -F @civ7/cli publish --access public
