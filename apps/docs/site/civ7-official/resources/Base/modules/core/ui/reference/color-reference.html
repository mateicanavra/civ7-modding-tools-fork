<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Icon Reference</title>
    <link rel="stylesheet" href="fs://game/core/ui/themes/default/fonts.css">
    <link rel="stylesheet" href="fs://game/core/ui/themes/default/default.css">
    <link rel="stylesheet" href="reference.css">
    <script src="fs://game/game/cohtml.js"></script>
    <script src="fs://game/game/component-support.js"></script>

    <style>
        fxs-icon {
            width: 32px;
            height: 32px;
            pointer-events: auto;
        }

        .paletteArea {
            display: flex;
            flex-wrap: wrap;
            flex-direction: column;
            align-content: flex-start;
            height: 110px;
            background-color: gray;
        }

        .playerArea {
            display: flex;
            flex-wrap: wrap;
            flex-direction: column;
            align-content: flex-start;
            height: 280px;
        }

        .swatch {
            width: 32px;
            height: 32px;
            pointer-events: auto;
            margin: 2px;
        }

        .selectedPrimary {
            border-width: 2px;
            border-style: solid;
            border-color: black;
        }

        .selectedSecondary {
            border-width: 2px;
            border-style: solid;
            border-color: white;
        }

        .bg {
            width: 32px;
            height: 32px;
            pointer-events: auto;
            margin: 2px 8px 2px 8px;
        }

        .icon {
            position: relative;
            bottom: 0px;
            width: 32px;
            height: 32px;
            max-width: 64px;
            max-height: 64px;
            background-image: url(fs://game/leader_symb_06.png);
            background-size: contain;
            background-position-x: 50%;
            background-position-y: 50%;
            background-repeat: no-repeat no-repeat;
            pointer-events: auto;
            margin: 0px;
        }

        .numBox {
            font-family: 'Helvetica', 'Arial';
            font-size: 24px;
            text-align: center;
            align-items: center;
            justify-content: center;
            color: #ddd;
            width: 32px;
            height: 32px;
            border: solid 1px #999;
            margin: 2px 4px 2px 4px;
        }
    </style>
</head>

<body>
    <div class="panel" style="width:1200px;height:620px">
        <fxs-scrollable class="panel-content">
            <div style="font-size: 2em">Palette</div>
            <div id="color-palette" class="paletteArea"></div>
            <div style="margin-top: 32px;"></div>
            <div style="font-size: 2em">Player Colors</div>
            <div id="player-group" class="playerArea"></div>
        </fxs-scrollable>
    </div>
    <div id="tooltip-root" class="new-tooltip--root absolute pointer-events-none" style="visibility:hidden">
        <div style="width: 100%; height:100%; background-color: rgba(99,99,99,0.5)">
            <div id="tooltip-root-content" style="display:flex" class="font-body-base">
            </div>
        </div>
    </div>

    <script type="text/javascript">
        colorsAsString =
            `<Row>
			<Type>COLOR_STANDARD_RED_LT</Type>
			<Color>230,117,117,255</Color>
		</Row>
		<Row>
			<Type>COLOR_STANDARD_RED_MD</Type>
			<Color>204,00,01,255</Color>
		</Row>
		<Row>
			<Type>COLOR_STANDARD_RED_DK</Type>
			<Color>120,0,1,255</Color>
		</Row>

		<Row>
			<Type>COLOR_STANDARD_ORANGE_LT</Type>
			<Color>254,178,62,255</Color>
		</Row>
		<Row>
			<Type>COLOR_STANDARD_ORANGE_MD</Type>
			<Color>255,129,18,255</Color>
		</Row>
		<Row>
			<Type>COLOR_STANDARD_ORANGE_DK</Type>
			<Color>148,74,1,255</Color>
		</Row>

        <Row>
			<Type>COLOR_STANDARD_YELLOW_LT</Type>
			<Color>250,236,127,255</Color>
		</Row>
		<Row>
			<Type>COLOR_STANDARD_YELLOW_MD</Type>
			<Color>247,216,1,255</Color>
		</Row>
		<Row>
			<Type>COLOR_STANDARD_YELLOW_DK</Type>
			<Color>134,114,2,255</Color>
		</Row>

		<Row>
			<Type>COLOR_STANDARD_GREEN_LT</Type>
			<Color>152,255,112,255</Color>
		</Row>
		<Row>
			<Type>COLOR_STANDARD_GREEN_MD</Type>
			<Color>77,187,0,255</Color>
		</Row>
		<Row>
			<Type>COLOR_STANDARD_GREEN_DK</Type>
			<Color>7,110,39,255</Color>
		</Row>

		<Row>
			<Type>COLOR_STANDARD_AQUA_LT</Type>
			<Color>126,233,228,255</Color>
		</Row>
		<Row>
			<Type>COLOR_STANDARD_AQUA_MD</Type>
			<Color>1,188,155,255</Color>
		</Row>
		<Row>
			<Type>COLOR_STANDARD_AQUA_DK</Type>
			<Color>4,80,83,255</Color>
		</Row>

		<Row>
			<Type>COLOR_STANDARD_BLUE_LT</Type>
			<Color>116,163,243,255</Color>
		</Row>
		<Row>
			<Type>COLOR_STANDARD_BLUE_MD</Type>
			<Color>0,80,205,255</Color>
		</Row>
		<Row>
			<Type>COLOR_STANDARD_BLUE_DK</Type>
			<Color>1,42,108,255</Color>
		</Row>

		<Row>
			<Type>COLOR_STANDARD_PURPLE_LT</Type>
			<Color>183,128,230,255</Color>
		</Row>
		<Row>
			<Type>COLOR_STANDARD_PURPLE_MD</Type>
			<Color>109,0,205,255</Color>
		</Row>
		<Row>
			<Type>COLOR_STANDARD_PURPLE_DK</Type>
			<Color>55,0,101,255</Color>
		</Row>

		<Row>
			<Type>COLOR_STANDARD_MAGENTA_LT</Type>
			<Color>255,153,255,255</Color>
		</Row>
		<Row>
			<Type>COLOR_STANDARD_MAGENTA_MD</Type>
			<Color>253,0,252,255</Color>
		</Row>
		<Row>
			<Type>COLOR_STANDARD_MAGENTA_DK</Type>
			<Color>117,0,115,255</Color>
		</Row>

		<Row>
			<Type>COLOR_STANDARD_WHITE_LT</Type>
			<Color>249,249,249,255</Color>
		</Row>
		<Row>
			<Type>COLOR_STANDARD_WHITE_MD2</Type>
			<Color>174,174,174,255</Color>
		</Row>
		<Row>
			<Type>COLOR_STANDARD_WHITE_MD</Type>
			<Color>113,113,113,255</Color>
		</Row>
		<Row>
			<Type>COLOR_STANDARD_WHITE_DK</Type>
			<Color>51,51,51,255</Color>
		</Row>        
        `;

        colorMap = new Map();
        primaryName = "";
        secondaryName = "";

        //
        // Extract Type and Color between <Row></Row> entries
        // xmlString, a string of color row entries like:
        //      <Row>
        //			<Type>COLOR_STANDARD_RED_LT</Type>
        //  	    <Color>229,117,116,255</Color>
        //      </Row>
        function extractRows(xmlString) {
            const rows = [];
            const rowRegex = /<Row>([\s\S]*?)<\/Row>/g; // Matches content between <Row> and </Row>
            let match;

            // Find all <Row>...</Row> blocks
            while ((match = rowRegex.exec(xmlString)) !== null) {
                const rowContent = match[1]; // Content inside <Row>...</Row>
                const typeMatch = rowContent.match(/<Type>(.*?)<\/Type>/);
                const colorMatch = rowContent.match(/<Color>(.*?)<\/Color>/);

                if (typeMatch && colorMatch) {
                    const type = typeMatch[1].trim();
                    const color = colorMatch[1].trim();
                    rows.push({ Type: type, Color: color });
                }
            }
            return rows;
        }

        function parseColorString(colorString) {
            const [r, g, b, a] = colorString.split(',').map(Number);
            return { r, g, b, a };
        }

        // returns: array of objects with Type,r,g,b,a where Type is name.
        function getColors() {
            database = extractRows(colorsAsString);
            const colors = database.map(row => {
                rgba = parseColorString(row.Color);
                colorMap.set(row.Type, { r: rgba.r, g: rgba.g, b: rgba.b, a: rgba.a });   // save in global map
                return { Type: row.Type, r: rgba.r, g: rgba.g, b: rgba.b, a: rgba.a };
            })
            return colors;
        }

        function rgbToHex(r, g, b) {
            return `#${((1 << 24) | (r << 16) | (g << 8) | b).toString(16).slice(1).toUpperCase()}`;
        }

        // convert an HTML color string to separate r,g,b values 0-255
        function hexToRgb(hex) {
            // Parse the r, g, b values from the normalized hex string
            const bigint = parseInt(hex.slice(0), 16);
            const r = (bigint >> 16) & 255;
            const g = (bigint >> 8) & 255;
            const b = bigint & 255;

            return { r, g, b };
        }

        function makeColorSwatch(title, r, g, b, a) {
            const swatch = document.createElement('div');
            swatch.classList.add("swatch");
            swatch.style.backgroundColor = `rgba(${r},${g},${b},${a})`;
            swatch.setAttribute('data-tooltip-content', `${rgbToHex(r, g, b)} ${title} - ${r},${g},${b}`);
            swatch.setAttribute('data-color-name', `${title}`);
            /*
            // debug
            if (title == "COLOR_STANDARD_GREEN_MD") {
                swatch.classList.add("selectedPrimary");
            }
            */
            return swatch;
        }

        // REMOVE once IconManager supports Civ icons
        function getCivSymbolFromCivilizationType(civilization) {
            const civDef = GameInfo.Civilizations.lookup(civilization);
            if (civDef) {
                return "fs://game/core/ui/civ_sym_" + civDef.CivilizationType.slice(13).toLowerCase();
            }
            return "";
        }

        function getCivIconURL(type) {
            return `url('${getCivSymbolFromCivilizationType(type)}')`;  // TODO: Change to Icon Manager reference.
        }

        function populatePlayer(player) {
            const id = player.id;
            const group = document.createElement('div');
            const primary = UI.Player.getPrimaryColorValueAsString(id);
            const secondary = UI.Player.getSecondaryColorValueAsString(id);

            const numBox = document.createElement('div');
            numBox.classList.add("numBox");
            numBox.innerHTML = id;

            const swatchPrimary = document.createElement('div');
            swatchPrimary.classList.add("swatch");
            swatchPrimary.style.backgroundColor = primary;

            const swatchSecondary = document.createElement('div');
            swatchSecondary.classList.add("swatch");
            swatchSecondary.style.backgroundColor = secondary;

            const iconbg = document.createElement('div');
            iconbg.classList.add("bg");
            iconbg.style.backgroundColor = primary;

            const icon = document.createElement('div');
            icon.classList.add("icon");
            //icon.style.backgroundImage = `url('fs://game/core/ui/civ_sym_maurya')`;     // url(fs://game/core/ui/civ_sym_maurya)
            //icon.style.backgroundImage = `url('${getCivSymbolFromCivilizationType(player.civilizationType)}')`; 
            //icon.style.backgroundImage = Icon.getCivSymbolFromCivilizationType(player.civilizationType);
            icon.style.backgroundImage = getCivIconURL(player.civilizationType);
            icon.style.filter = `fxs-color-tint(${secondary})`;
            iconbg.appendChild(icon);

            group.appendChild(numBox);
            group.appendChild(iconbg);
            group.appendChild(swatchPrimary);
            group.appendChild(swatchSecondary);
            group.style = "margin-right: 64px;";

            group.addEventListener('mousedown', (event) => {
                const name = (event.button) == 0 ? secondaryName : primaryName;
                const color = colorMap.get(name);
                const rgba = `rgba(${color.r}, ${color.g}, ${color.b}, ${color.a})`;
                if (event.button == 0) {
                    iconbg.style.backgroundColor = rgba;
                    swatchSecondary.style.backgroundColor = rgba;
                } else {
                    icon.style.filter = `fxs-color-tint(${rgba})`;
                    swatchPrimary.style.backgroundColor = rgba;
                }
                group.setAttribute('data-tooltip-content', `<p>p: ${primaryName}</p><br><p>s: ${secondaryName}</p>`);
            });

            return group;
        }

        // container a <div> to draw palette
        // colors an array with Type,r,g,b,a of colors with Type being the name.
        function buildPalette(container, colors) {
            colors.forEach(element => {
                //console.log("color:", element.Type, element.r, element.g, element.b, element.a);
                const swatch = makeColorSwatch(element.Type, element.r, element.g, element.b, element.a);
                swatch.addEventListener('mousedown', (event) => {
                    const item = (event.button) == 0 ? "selectedSecondary" : "selectedPrimary";
                    const selectedSwatch = document.querySelector(`.swatch.${item}`);
                    if (selectedSwatch) {
                        selectedSwatch.classList.remove(`${item}`);
                    }
                    swatch.classList.add(`${item}`);  // and select

                    // Set globals
                    if (event.button == 0) {
                        primaryName = swatch.getAttribute("data-color-name");
                    } else {
                        secondaryName = swatch.getAttribute("data-color-name");
                    }
                });
                container.appendChild(swatch);
            });
        }

        Loading.runWhenLoaded(() => {
            console.log("color-reference script start")

            // Draw palette            
            const container = document.getElementById('color-palette');
            const colors = getColors();
            if (container && colors) {
                buildPalette(container, colors);
            } else {
                if (!container) console.error("Couldn't find color-palette to put the colors.")
                if (!colors) console.error("Couldn't find colors array to use.")
            }

            if (UI.isInGame()) {
                const players = document.getElementById('player-group');

                // Draw existing player colors
                const playerList = Players.getEverAlive();
                playerList.forEach((player) => {
                    //if (Players.isAlive(player.id))
                    players.appendChild(populatePlayer(player));
                });
            }
            //console.log("color-reference script end")
        });
        console.log("done loading")

        console.log("Desired colors")
        let desired = [
            "4d7c96", "cc0001", "780001",
            "feb23e", "ff8112", "944a01",
            "faec7f", "f7d801", "867202",
            "98ff70", "4dbb00", "076e27",
            "7ee9e4", "01bc9b", "045053",
            "74a3f3", "0050cd", "012a6c",
            "b780e6", "6d00cd", "370065",
            "ff99ff", "fd00fc", "750073",
            "f9f9f9", "717171", "333333",
            "aeaeae"]
        let strength = 0;
        desired.forEach(value => {
            let rgb = hexToRgb(value);
            let prefix = "";
            switch (strength) {
                case 0: prefix = "lt: "; break;
                case 1: prefix = "md: "; break;
                case 2: prefix = "dk: "; break;
                default: prefix = "??: "; break;
            }
            console.log(prefix + rgb.r + "," + rgb.g + "," + rgb.b + ",255");
            strength = (strength + 1) % 3;
            if (strength == 0) console.log("");
        })

    </script>
</body>

</html>